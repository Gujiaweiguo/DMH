# Spec: 会员系统（Member System）

## ADDED Requirements

### Requirement: 会员平台唯一标识（UnionID）
系统 SHALL 以 `unionid` 作为会员（Member）的平台唯一标识，用于跨活动识别同一人。

#### Scenario: 使用 unionid 创建或查找会员
- **WHEN** 系统收到包含 `unionid` 的参与/下单请求
- **THEN** 系统 SHALL 以 `unionid` 查找已存在会员
- **AND** 若不存在则 SHALL 创建新会员并确保 `unionid` 全局唯一

#### Scenario: unionid 缺失时禁止创建会员
- **WHEN** 请求无法提供 `unionid`
- **THEN** 系统 SHALL 不创建会员记录
- **AND** 返回可理解的提示信息说明需要完成授权以获取 unionid

### Requirement: 会员档案沉淀（画像与资产）
系统 SHALL 为会员沉淀可用于分析的档案信息，包括基础资料、标签、来源渠道、参与历史、支付与奖励汇总。

#### Scenario: 参与活动时沉淀参与历史
- **WHEN** 会员成功参与一个活动（提交表单并产生参与/订单记录）
- **THEN** 系统 SHALL 将该活动关联到会员参与历史
- **AND** 可按时间查看会员参与轨迹

#### Scenario: 支付与奖励数据汇总
- **WHEN** 会员产生支付或奖励记录
- **THEN** 系统 SHALL 将支付与奖励与该会员关联
- **AND** 在会员详情中展示汇总指标（如累计支付、累计奖励、最近一次参与/支付时间）

#### Scenario: 标签与分群沉淀
- **WHEN** 平台管理员为会员添加/移除标签
- **THEN** 系统 SHALL 保存标签变更
- **AND** 支持按标签筛选会员用于分群分析

### Requirement: 品牌可见性与会员-品牌关联
系统 SHALL 支持会员与品牌的关联关系，并用于数据隔离与品牌视角分析。

#### Scenario: 参与本品牌活动后自动建立品牌关联
- **WHEN** 会员参与某品牌的活动
- **THEN** 系统 SHALL 自动建立该会员与该品牌的关联
- **AND** 品牌管理员在会员列表中可检索到该会员

#### Scenario: 平台管理员查看全量会员
- **WHEN** 平台管理员访问会员列表/详情
- **THEN** 系统 SHALL 允许查看全量会员数据

#### Scenario: 品牌管理员仅查看本品牌会员
- **WHEN** 品牌管理员访问会员列表/详情
- **THEN** 系统 SHALL 仅返回与其品牌有关联的会员

### Requirement: 人工合并会员
系统 SHALL 提供人工合并能力，由平台管理员将重复会员合并为一个主会员，并迁移关联数据。

#### Scenario: 创建合并并选择主会员
- **WHEN** 平台管理员选择两个会员发起合并
- **THEN** 系统 SHALL 要求选择一个主会员（保留者）
- **AND** 预览将被迁移的关联数据（品牌关联、参与历史、订单、奖励、标签）

#### Scenario: 合并约束校验
- **WHEN** 平台管理员尝试合并两个都包含不同 `unionid` 的会员
- **THEN** 系统 SHALL 拒绝合并
- **AND** 提示“unionid 冲突，需要先确认身份策略”

#### Scenario: 合并执行与可追溯审计
- **WHEN** 合并执行成功
- **THEN** 系统 SHALL 将被合并会员的关联数据迁移到主会员
- **AND** 记录合并审计日志（操作者、时间、合并前后 ID、迁移范围）

### Requirement: 导出审批（不脱敏）
系统 SHALL 支持会员数据导出申请与审批流程：品牌管理员申请、平台管理员审批后生成导出。

#### Scenario: 品牌管理员发起导出申请
- **WHEN** 品牌管理员提交导出申请（包含筛选条件与导出原因）
- **THEN** 系统 SHALL 创建导出请求并进入“待审批”状态
- **AND** 记录申请人、品牌、时间与参数

#### Scenario: 平台管理员审批通过并生成导出
- **WHEN** 平台管理员审批通过导出申请
- **THEN** 系统 SHALL 生成导出文件
- **AND** 导出内容不做脱敏
- **AND** 导出结果对申请人可下载

#### Scenario: 审批驳回
- **WHEN** 平台管理员驳回导出申请
- **THEN** 系统 SHALL 记录驳回原因
- **AND** 申请人可查看驳回原因并重新发起申请

### Requirement: 数据保留
系统 SHALL 永久保留会员数据与导出审批记录，用于审计与长期分析。

#### Scenario: 永久保留导出审批记录
- **WHEN** 导出申请被审批或生成导出
- **THEN** 系统 SHALL 永久保留审批链路记录
- **AND** 平台管理员可查询历史审批记录

### Requirement: 分析问题支持（口径）
系统 SHALL 提供支持以下分析问题所需的数据口径与查询能力：跨活动漏斗、复购/复参、渠道质量、用户分群、生命周期。

#### Scenario: 跨活动漏斗
- **WHEN** 平台管理员选择一个时间范围
- **THEN** 系统 SHALL 能统计从“曝光/访问→参与→下单→支付→奖励结算”的跨活动漏斗数据

#### Scenario: 复购/复参
- **WHEN** 平台管理员查看会员指标
- **THEN** 系统 SHALL 能区分首次参与与再次参与
- **AND** 能统计复参率/复购率等指标

#### Scenario: 渠道质量与分群
- **WHEN** 平台管理员按渠道或标签筛选
- **THEN** 系统 SHALL 输出对应人群的参与、支付、奖励等指标用于对比
