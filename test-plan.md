# DMH 系统测试计划

> 基于文档：`all-requirements.md`（版本 1.0，2026-02-14）
> 计划版本：v1.0
> 测试对象：DMH（backend + frontend-admin + frontend-h5）

---

## 1. 测试目标

- 验证当前有效规格（campaign-management、order-payment-system、rbac-permission-system、feedback-system、spec-governance）在功能、权限、稳定性与可追溯性上满足需求。
- 覆盖 P0 核心业务链路：认证授权、活动管理、订单流程、关键权限边界。
- 通过正常与异常场景验证系统的容错能力（鉴权失败、参数错误、超时、重复请求、并发冲突等）。
- 输出可追溯测试证据：测试记录、日志、失败截图/报文、回归报告。

## 2. 测试范围

### 2.1 In Scope

1. 活动管理系统（CM-01 ~ CM-06）
2. 订单支付系统（OP-01）
3. RBAC 权限系统（RBAC-01 ~ RBAC-12）
4. 反馈系统（FB-01 ~ FB-09）
5. 规格治理（SG-01 ~ SG-02）

### 2.2 Out of Scope

- 第三方平台真实生产联调（如微信真实支付清算）不在本轮系统测试范围，使用沙箱/Mock 替代。
- UI 视觉细节像素级验收不作为阻塞项（仅验证功能与交互可用性）。

## 3. 测试策略

### 3.1 测试类型与分层

- 单元测试：核心逻辑（订单创建/核销、权限判定、状态流转、字段校验）。
- API 集成测试：鉴权、角色隔离、事务一致性、缓存失效、错误码语义。
- E2E 测试：关键用户旅程（H5 注册/报名/反馈，Admin 用户与权限管理，品牌管理员活动编辑）。
- 非功能测试：
  - 性能：订单创建吞吐（目标 100 QPS）、关键链路响应时间。
  - 稳定性：超时重试、防抖去重、重复请求幂等。
  - 安全：JWT 过期/伪造、越权访问、敏感操作审计日志。

### 3.2 测试方法

- 风险驱动：P0（认证、订单、活动）优先，P1（反馈、分销监控、治理）次之。
- 等价类 + 边界值：密码长度、评分区间（1-5）、分销层级（1-3）。
- 状态迁移：反馈状态、订单核销/取消核销、用户状态（active/disabled/locked）。
- 异常注入：超时、重复提交、非法参数、权限不足、缓存未命中。

### 3.3 环境与数据策略

- 环境地址：
  - API：`http://localhost:8889`
  - Admin：`http://localhost:3000`
  - H5：`http://localhost:3100`
- 基础数据：
  - 平台管理员：`admin / 123456`
  - 品牌管理员：`brand_manager / 123456`
- 数据准备：初始化测试库、准备跨品牌测试数据、准备活动有效/过期样本、准备可核销/已核销订单样本。

### 3.4 入口与出口准则

**入口准则**

- 测试环境服务可访问，数据库与缓存已初始化。
- 本轮构建完成，核心依赖可用。
- 基础账号、品牌、活动、订单测试数据准备完成。

**出口准则**

- P0 用例通过率 = 100%。
- P1 用例通过率 >= 95%，且无阻塞级缺陷。
- 阻塞/严重缺陷全部关闭或有明确风险豁免。
- 回归报告与测试证据归档完成。

## 4. 测试执行与自动化

### 4.1 推荐执行顺序

1. RBAC/认证授权
2. 活动管理
3. 订单支付与核销
4. 反馈系统
5. 规格治理与回归收尾

### 4.2 自动化命令基线

```bash
# 后端单元测试
cd backend && go test ./... -v

# 后端集成测试
cd backend
export DMH_INTEGRATION_BASE_URL=http://localhost:8889
go test ./test/integration/... -v -count=1

# 订单回归
backend/scripts/run_order_mysql8_regression.sh

# 前端测试
cd frontend-admin && npm run test && npm run test:e2e
cd frontend-h5 && npm run test && npm run test:e2e
```

## 5. 测试用例（正常 + 异常）与预期结果

说明：`类型`中“正常”表示主流程；“异常”表示错误输入、越权、状态冲突、超时等场景。

### 5.1 RBAC 与认证（P0）

| 用例ID | 类型 | 场景描述 | 前置条件 | 预期结果 |
|---|---|---|---|---|
| TC-RBAC-01 | 正常 | H5 用户注册 participant | 未登录，手机号未占用 | 返回 200，创建用户成功，角色为 participant，返回 JWT |
| TC-RBAC-02 | 异常 | H5 注册尝试指定 brand_admin 角色 | 未登录 | 返回 403/400，不允许创建高权限角色 |
| TC-RBAC-03 | 正常 | 平台管理员后台创建 brand_admin | admin 已登录 | 返回 200，用户创建成功并绑定指定角色 |
| TC-RBAC-04 | 异常 | 非平台管理员创建 platform_admin | brand_admin 已登录 | 返回 403，拒绝操作并记录审计日志 |
| TC-RBAC-05 | 正常 | 用户登录并校验 JWT claims | 账号可用 | 返回 200，token 包含 userId/role/exp |
| TC-RBAC-06 | 异常 | token 过期后访问受保护 API | 使用过期 token | 返回 401，前端触发清理 token 与重登流程 |
| TC-RBAC-07 | 异常 | 品牌管理员访问其他品牌数据 | brand_admin A 登录 | 返回 403 或空数据，严禁跨品牌泄露 |
| TC-RBAC-08 | 正常 | 权限变更后缓存立即失效 | 已命中权限缓存 | 权限更新后下一次请求按新权限生效 |
| TC-RBAC-09 | 正常 | 平台管理员审核提现申请 | 存在待审核提现单 | 返回 200，状态更新成功并记录事务日志 |
| TC-RBAC-10 | 异常 | participant 发起提现审核 | participant 登录 | 返回 403，拒绝审批 |
| TC-RBAC-11 | 正常 | 登录后返回菜单权限树 | 用户已分配菜单权限 | 返回可访问菜单列表，结构与权限一致 |
| TC-RBAC-12 | 异常 | 异常登录触发安全审计 | 连续错误密码登录 | 记录安全事件日志（用户/IP/时间/事件类型） |
| TC-RBAC-13 | 异常 | 分销监控请求超时处理 | 模拟后端超时 | 前端显示明确超时提示并提供重试入口 |

### 5.2 活动管理（P0）

| 用例ID | 类型 | 场景描述 | 前置条件 | 预期结果 |
|---|---|---|---|---|
| TC-CAMP-01 | 正常 | 品牌管理员进入页面设计器 | brand_admin 登录并进入活动编辑 | 成功展示移动端优化设计界面 |
| TC-CAMP-02 | 正常 | 添加组件到画布 | 设计器已打开 | 组件成功加入画布并有视觉反馈 |
| TC-CAMP-03 | 正常 | 编辑组件内容并实时预览 | 画布存在组件 | 属性修改后即时反映在画布 |
| TC-CAMP-04 | 正常 | 保存页面配置并重新加载 | 完成编辑 | 保存成功；重新打开活动可恢复配置 |
| TC-CAMP-05 | 异常 | 缺少必填字段直接保存 | 删除关键必填项 | 返回校验错误，禁止保存 |
| TC-CAMP-06 | 异常 | 未保存改动直接退出 | 存在未保存变更 | 弹出未保存警告，用户可取消退出 |
| TC-CAMP-07 | 正常 | 自动保存机制验证 | 连续编辑并停顿 | 在配置存储中看到自动保存版本 |
| TC-CAMP-08 | 正常 | 海报生成功能 | 活动配置完整 | 返回可访问海报 URL，可预览/下载 |
| TC-CAMP-09 | 正常 | 配置分销规则 1-3 级 | 开启分销设置 | 保存成功，奖励比例落库 |
| TC-CAMP-10 | 异常 | 配置 4 级分销 | 分销层级输入 4 | 返回校验失败，不允许保存 |
| TC-CAMP-11 | 异常 | 移动端触摸区过小 | 模拟小屏设备 | 核心操作按钮触控区域不低于 44x44（否则缺陷） |

### 5.3 订单支付与核销（P0）

| 用例ID | 类型 | 场景描述 | 前置条件 | 预期结果 |
|---|---|---|---|---|
| TC-ORDER-01 | 正常 | 创建订单（有效活动） | 活动有效、用户信息合法 | 返回 200，订单创建成功并生成核销码 |
| TC-ORDER-02 | 异常 | 重复手机号报名同活动 | 已有同活动报名记录 | 返回业务错误，拦截重复报名 |
| TC-ORDER-03 | 异常 | 活动无效/已过期时下单 | 活动状态无效 | 返回业务错误，不创建订单 |
| TC-ORDER-04 | 异常 | 关键字段格式不合法 | 提交非法手机号/邮箱等 | 返回字段校验错误并指明字段 |
| TC-ORDER-05 | 正常 | 品牌管理员核销订单 | 订单待核销、权限正确 | 核销成功，状态更新并记录操作者 |
| TC-ORDER-06 | 异常 | 无权限用户核销订单 | participant 登录 | 返回 403，状态不变 |
| TC-ORDER-07 | 异常 | 重复核销同一订单 | 订单已核销 | 返回重复核销错误，保持幂等 |
| TC-ORDER-08 | 正常 | 取消核销并状态回滚 | 订单已核销 | 回滚成功，可再次进入待核销状态 |
| TC-ORDER-09 | 正常 | 主干合入前最小冒烟 | 回归环境可用 | 关键路径通过并输出可追溯测试报告 |
| TC-ORDER-10 | 异常 | 并发下单压力场景 | 压测工具模拟并发 | 达到目标吞吐时无明显错误率飙升，重复防护有效 |

### 5.4 反馈系统（P1）

| 用例ID | 类型 | 场景描述 | 前置条件 | 预期结果 |
|---|---|---|---|---|
| TC-FEED-01 | 正常 | 用户提交反馈（完整字段） | participant 登录 | 返回 200，反馈记录创建成功 |
| TC-FEED-02 | 异常 | 缺少必填字段提交 | 缺标题/内容/类别 | 返回 400，指出缺失字段 |
| TC-FEED-03 | 异常 | rating 超范围提交 | rating=0 或 6 | 返回 400，评分范围错误 |
| TC-FEED-04 | 正常 | 普通用户查询自己的反馈列表 | participant 登录 | 仅返回当前用户反馈，分页有效，按时间倒序 |
| TC-FEED-05 | 异常 | 普通用户访问他人反馈详情 | participant A 访问 B 的反馈ID | 返回 403 |
| TC-FEED-06 | 正常 | 管理员更新反馈状态并回复 | admin 登录 | 状态更新成功，记录处理人/处理时间 |
| TC-FEED-07 | 异常 | 非管理员更新反馈状态 | participant 登录 | 返回 403，状态不变 |
| TC-FEED-08 | 正常 | 提交满意度调查 | participant 登录 | 评分保存成功，维度数据完整 |
| TC-FEED-09 | 正常 | FAQ 查询与关键词检索 | FAQ 已发布 | 返回已发布 FAQ，排序按 sort_order 升序 |
| TC-FEED-10 | 异常 | FAQ 重复点赞/踩 | 同一用户重复操作 | 第二次操作被拦截或幂等处理 |
| TC-FEED-11 | 正常 | 管理员查看反馈统计分析 | admin 登录 | 返回总量、分类、状态、优先级、评分分布等统计 |
| TC-FEED-12 | 异常 | 非管理员访问统计分析 | participant 登录 | 返回 403 |
| TC-FEED-13 | 正常 | 功能使用统计异步写入 | 执行功能操作 | 主流程响应不受阻塞，统计记录异步落库 |

### 5.5 规格治理（P1）

| 用例ID | 类型 | 场景描述 | 前置条件 | 预期结果 |
|---|---|---|---|---|
| TC-SG-01 | 正常 | 归档任务冲突状态归一化 | 准备含冲突状态样本 | tasks.md 保留单一权威状态，附解释说明 |
| TC-SG-02 | 正常 | 归档状态可追溯索引完整性 | 归档目录可访问 | 可导航索引存在，关联变更与状态来源可追溯 |

## 6. 缺陷分级与通过标准

- Blocker：核心链路不可用、数据错乱、越权泄露。
- Critical：主要功能失败、事务不一致、权限控制失效。
- Major：功能可用但结果错误、稳定性明显下降。
- Minor：低风险体验问题或提示问题。

发布建议：无 Blocker/Critical，且 P0 全通过方可发布。

## 7. 交付物

- 测试用例执行记录（含环境、时间、执行人、结果）。
- 缺陷清单（严重级、复现步骤、影响范围、修复状态）。
- 回归测试报告（覆盖率、通过率、剩余风险、发布结论）。

---

如 `all-requirements.md` 变更（新增需求/场景），应同步增补本计划中的范围矩阵和测试用例。
