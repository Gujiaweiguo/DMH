# DMH 测试执行计划

## 执行概览

本文档跟踪测试计划的执行进度，目标：整体覆盖率 > 70%。

## Epic A：测试基建与门禁（第 1 周）

| 任务 | 状态 | 完成时间 | 备注 |
|------|------|---------|------|
| A1｜前端覆盖率插件接入（admin） | ✅ 完成 | 2026-02-12 | 安装 @vitest/coverage-v8@^2.0.0 |
| A2｜前端覆盖率插件接入（h5） | ✅ 完成 | 2026-02-12 | 安装 @vitest/coverage-v8@^2.0.0 |
| A3｜E2E CI 模式配置（headless） | ✅ 完成 | 2026-02-12 | 支持 CI=true 下 headless 运行 |
| A4｜统一测试门禁脚本 | ✅ 完成 | 2026-02-12 | 创建 scripts/test-all.sh |
| A5｜覆盖率阈值分阶段策略 | ✅ 完成 | 2026-02-12 | 创建 docs/COVERAGE_THRESHOLD_PLAN.md |

**Week 1 里程碑**：✅ 已完成

## Epic B：后端 P0 覆盖率提升（第 2 周）

| 任务 | 状态 | 完成时间 | 备注 |
|------|------|---------|------|
| B1｜`auth` 模块测试扩展 | 🔄 进行中 | - | 预估 3 人天 |
| B2｜`statistics` 模块主逻辑补测 | ⏳ 待执行 | - | 预估 2 人天 |
| B3｜`brand` 模块测试扩展 | ⏳ 待执行 | - | 预估 2.5 人天 |
| B4｜P0 阶段回归与覆盖率复核 | ⏳ 待执行 | - | 预估 0.5 人天 |

**Week 2 目标**：后端总覆盖率到 60%+

## Epic C：后端 P1 扫尾（第 3 周）

| 任务 | 状态 | 完成时间 | 备注 |
|------|------|---------|------|
| C1｜`middleware` 补测 | ⏳ 待执行 | - | 预估 1.5 人天 |
| C2｜`admin` 与 `withdrawal` 补测 | ⏳ 待执行 | - | 预估 2.5 人天 |
| C3｜`syncadapter` 行为测试增强 | ⏳ 待执行 | - | 预估 1.5 人天 |
| C4｜后端全量复核 | ⏳ 待执行 | - | 预估 0.5 人天 |

**Week 3 目标**：后端总覆盖率到 68~72%

## Epic D：前端覆盖率冲刺 + E2E（第 4 周）

| 任务 | 状态 | 完成时间 | 备注 |
|------|------|---------|------|
| D1｜管理后台单测扩面 | ⏳ 待执行 | - | 预估 2.5 人天 |
| D2｜H5 单测扩面 | ⏳ 待执行 | - | 预估 2 人天 |
| D3｜E2E smoke 套件固化（PR 门禁） | ⏳ 待执行 | - | 预估 1 人天 |
| D4｜E2E full 回归（夜间） | ⏳ 待执行 | - | 预估 0.5 人天 |

**Week 4 目标**：admin/h5 各自 >70%，全项目口径冲线 >70%

## 当前状态

- **后端覆盖率**：68.8%（⬆️ 从 67.0% 提升 1.8%）
- **管理后台覆盖率**：~4.4%（基线 ~4% → +0.4%）
- **H5 覆盖率**：~1.1%（基线 ~1% → +0.1%）
- **E2E**：21 条（admin）+ 7 条（h5）配置完成，20/21 通过

## Epic B：后端 P0 覆盖率提升（第 2 周）

| 任务 | 状态 | 完成时间 | 备注 |
| | B1｜`auth` 模块测试扩展 | ✅ 完成 | 2026-02-12 | 21.4% → 57.1% (+35.7%) |
| | B2｜`statistics` 模块主逻辑补测 | ✅ 完成 | 2026-02-12 | 8.9% → 72.2% (+63.3%) |
| | B3｜`brand` 模块测试扩展 | ✅ 完成 | 2026-02-12 | 31.0% → 67.1% (+36.1%) |
| | B4｜P0 阶段回归与覆盖率复核 | ✅ 完成 | 2026-02-12 | 已创建差距报告和收尾清单 |

**Week 2 里程碑**：✅ 已完成（后端 74.9%，历史口径）

## Epic C：后端 P1 扫尾（第 3 周）

| 任务 | 状态 | 完成时间 | 备注 |
| | C1｜`auth` 模块补测 | ✅ 完成 | 2026-02-12 | 57.1% → 71.5% (+14.4%) |
| | C2｜`brand` 模块微调 | ✅ 完成 | 2026-02-12 | 67.1% → 77.6% (+10.5%) |
| | C3｜`middleware` 补测 | ✅ 完成 | 2026-02-12 | 62.2% → 66.8% (+4.6%) |
| | C4｜`admin` 模块补测 | ⏸️ 部分完成 | 2026-02-12 | 60.0% (未达 70% 目标) |
| | C5｜`withdrawal` 模块补测 | ⏸️ 部分完成 | 2026-02-12 | 63.0% (未达 70% 目标) |
| | C6｜后端全量复核与覆盖率验证 | ✅ 完成 | 2026-02-12 | 整体 76.7%（历史口径） |

**Week 3 目标**：后端总覆盖率 68~72%
**Week 3 实际**：后端总覆盖率 76.7%（历史口径）

## 下一步行动

1. Week 4 - Epic D：前端覆盖率冲刺 + E2E

## 注意事项

- 存在 44 个 scaffold 占位逻辑需要最小可用实现
- 前端覆盖率当前较低，需要大量补充
- E2E 测试需要稳定化后才能作为 PR 门禁

---

最后更新：2026-02-12

## Week 2 总结

> 说明：以下 Week 2/3/4 总结为 2026-02-12 归档记录，使用当时覆盖率统计口径。
> 与当前统一口径（`go test ./... -coverprofile=coverage.out -covermode=atomic`，后端 67.0%）不可直接横向比较。

Week 2 目标超额完成：
- ✅ 后端整体覆盖率从 50% 提升到 74.9%（历史口径）
- ✅ 超过 60% 目标 14.9 个百分点
- ✅ 三个 P0 模块均有显著提升：
  - auth: 21.4% → 57.1% (+35.7%)
  - statistics: 8.9% → 72.2% (+63.3%)
  - brand: 31.0% → 67.1% (+36.1%)
- ✅ 创建了覆盖率差距报告 (COVERAGE_GAP_REPORT.md)
- ✅ 创建了 Week 2 收尾清单 (WEEK2_CLOSING_CHECKLIST.md)

Week 2 任务状态：🎯 **全部完成**

## Week 3 总结

Week 3 目标超额完成：
- ✅ 后端整体覆盖率从 74.9% 提升到 76.7%（历史口径）
- ✅ 超过 68-72% 目标范围
- ✅ 核心模块均有提升：
  - auth: 57.1% → 71.5% (+14.4%) ✅ 达到 70% 目标
  - brand: 67.1% → 77.6% (+10.5%) ✅ 超过 70% 目标
  - middleware: 62.2% → 66.8% (+4.6%) 🟡 接近 70% 目标
- ⏸️ admin 和 withdrawal 模块未达 70% 目标，但按当时口径整体覆盖率已达标

Week 3 任务状态：🎯 **超额完成**

## Week 4 总结

Week 4 目标部分完成：
- ✅ 后端覆盖率维持在 76.7%（历史口径）
- 🔴 管理后台覆盖率 4.4% 未达 70% 目标
- 🔴 H5 覆盖率 1.1% 未达 70% 目标
- ✅ E2E 测试基本稳定 (20/21 通过)
- ✅ 创建了 Week 4 执行报告 (WEEK4_EXECUTION_REPORT.md)
- ✅ 创建了 4 周总结报告 (4WEEKS_TEST_COVERAGE_SUMMARY.md)

Week 4 任务状态：🟡 部分完成（后端按历史口径达标，前端未达标）

## 4 周整体总结

### 覆盖率变化

| 阶段 | 后端 | Admin | H5 |
|------|------|-------|-----|
| 基线 | ~50% | ~4% | ~1% |
| Week 1 | - | - | - |
| Week 2 | 74.9%（历史口径） | - | - |
| Week 3 | 76.7%（历史口径） | - | - |
| Week 4 | 76.7%（历史口径） | 4.4% | 1.1% |
| 变化 | +26.7% | +0.4% | +0.1% |

### 关键成就

1. ✅ 后端覆盖率大幅提升：50% → 76.7%（历史口径）
2. ✅ 后端模块达标率高：15/17 个模块达到 70%+
3. ✅ E2E 测试稳定：96.4% 通过率 (27/28)
4. ✅ 测试基础设施完善：vitest, playwright, coverage 配置完成

### 需要持续改进

1. 🔴 前端覆盖率极低：需要持续投入大量时间
   - Admin: 4.4% → 70% (需 +65.6%)
   - H5: 1.1% → 70% (需 +68.9%)
2. 🔴 全项目平均未达标：51.9% vs 70% (差 -18.1%)
3. 🟡 部分 P1 模块未达标：admin, withdrawal 模块
4. 🟡 1 个 E2E 测试失败

### 建议

1. **优先前端覆盖率提升**：将前端测试作为长期重点工作
2. **分阶段逐步提升**：每阶段提升 15-20% 覆盖率
3. **建立测试文化**：PR 审查要求测试覆盖率，CI 自动化检查
4. **持续改进**：定期生成覆盖率报告，优化测试质量

---

**最后更新**: 2026-02-12
**4 周测试计划总结**: 历史阶段后端达标（历史口径），前端未达标；当前统一口径下后端仍需提升到 70%

## 2026-02-14 补充进展

- ✅ 已执行数据库迁移：`backend/migrations/20260214_fix_faq_items_counter_columns.sql`
  - 修复历史拼写列 `helpul_count`
  - 补齐 `not_helpful_count`
- ✅ `feedback` 集成回归通过：`FeedbackHandlerIntegrationTestSuite`
- ✅ backend 全量测试通过：`go test ./...`
- ✅ 覆盖率口径统一：后端总覆盖率 67.0%
- ✅ 已执行会员表迁移：`backend/migrations/20260214_create_members_tables.sql`
  - 创建 `members` 和 `member_profiles` 表
  - 插入测试会员数据
- ✅ `MemberHandlerIntegrationTestSuite` 从 Skip 转为 PASS（7 subtests）
- ✅ **集成测试 100% 通过**：27/27 套件，0 Skip，耗时 3.910s

**最后更新**: 2026-02-14

## 2026-02-14 覆盖率提升记录

- ✅ handler/brand 测试补充：36.8% → 67.0% (+30.2%)
- ✅ handler/distributor 测试补充：49.0% → 56.0% (+7.0%)
- ✅ handler/withdrawal 测试补充：42.6% → 68.5% (+25.9%)
- ✅ handler/security 测试补充：44.7% → 78.9% (+34.2%)
- ✅ 后端总覆盖率提升：67.0% → 68.8% (+1.8%)
