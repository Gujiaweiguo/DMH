<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>订单管理 - DMH 管理后台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="p-6">
    <div class="max-w-7xl mx-auto">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">订单管理</h1>
          <p class="text-gray-500 mt-1">查看所有活动的报名订单</p>
        </div>
        <a href="http://localhost:3001" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">返回主页</a>
      </div>

      <!-- 筛选区 -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">按活动筛选</label>
            <select id="campaignFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2">
              <option value="">全部活动</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">手机号搜索</label>
            <input type="text" id="phoneSearch" placeholder="输入手机号" class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>
          <button onclick="loadOrders()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">查询</button>
        </div>
      </div>

      <!-- 统计卡片 -->
      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-4">
          <div class="text-sm text-gray-500">订单总数</div>
          <div id="statTotal" class="text-2xl font-bold text-gray-900 mt-2">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
          <div class="text-sm text-gray-500">待支付</div>
          <div id="statPending" class="text-2xl font-bold text-amber-600 mt-2">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
          <div class="text-sm text-gray-500">已支付</div>
          <div id="statPaid" class="text-2xl font-bold text-green-600 mt-2">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
          <div class="text-sm text-gray-500">总金额</div>
          <div id="statAmount" class="text-2xl font-bold text-indigo-600 mt-2">¥0</div>
        </div>
      </div>

      <!-- 订单列表 -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-50 border-b">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">订单ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">活动名称</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">手机号</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">金额</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">报名时间</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
            </tr>
          </thead>
          <tbody id="orderTable" class="divide-y divide-gray-200">
            <tr><td colspan="7" class="px-6 py-8 text-center text-gray-400">加载中...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 分页 -->
      <div class="mt-4 flex justify-between items-center">
        <div class="text-sm text-gray-500">
          共 <span id="totalCount">0</span> 条记录
        </div>
        <div class="flex gap-2">
          <button onclick="previousPage()" id="prevBtn" class="px-4 py-2 border rounded-lg hover:bg-gray-50">上一页</button>
          <span class="px-4 py-2">第 <span id="currentPage">1</span> 页</span>
          <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 border rounded-lg hover:bg-gray-50">下一页</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 详情弹窗 -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-auto">
      <div class="p-6 border-b flex justify-between items-center">
        <h3 class="text-xl font-bold">订单详情</h3>
        <button onclick="closeDetail()" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>
      <div id="detailContent" class="p-6"></div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const pageSize = 10;
    let total = 0;
    let campaigns = {};

    // 加载活动列表（用于筛选）
    async function loadCampaigns() {
      const res = await fetch('/api/v1/campaigns');
      const data = await res.json();
      campaigns = {};
      data.campaigns.forEach(c => campaigns[c.id] = c);
      
      const select = document.getElementById('campaignFilter');
      select.innerHTML = '<option value="">全部活动</option>';
      data.campaigns.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
    }

    // 加载订单列表
    async function loadOrders() {
      const campaignId = document.getElementById('campaignFilter').value;
      const phone = document.getElementById('phoneSearch').value.trim();
      
      let url = `/api/v1/orders?page=${currentPage}&pageSize=${pageSize}`;
      if (campaignId) url += `&campaignId=${campaignId}`;
      
      const res = await fetch(url);
      const data = await res.json();
      
      total = data.total;
      document.getElementById('totalCount').textContent = total;
      document.getElementById('currentPage').textContent = currentPage;
      
      // 更新统计
      updateStats(data.orders);
      
      // 渲染表格
      const tbody = document.getElementById('orderTable');
      if (data.orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-400">暂无订单</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.orders
        .filter(o => !phone || o.phone.includes(phone))
        .map(order => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 text-sm text-gray-500">#${order.id}</td>
            <td class="px-6 py-4 text-sm font-medium text-gray-900">${campaigns[order.campaignId]?.name || '未知活动'}</td>
            <td class="px-6 py-4 text-sm text-gray-900">${order.phone}</td>
            <td class="px-6 py-4 text-sm font-semibold text-gray-900">¥${order.amount.toFixed(2)}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                order.status === 'paid' ? 'bg-green-100 text-green-800' : 
                order.status === 'pending' ? 'bg-amber-100 text-amber-800' : 
                'bg-gray-100 text-gray-800'
              }">${
                order.status === 'paid' ? '已支付' : 
                order.status === 'pending' ? '待支付' : order.status
              }</span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">${new Date(order.createdAt).toLocaleString()}</td>
            <td class="px-6 py-4">
              <button onclick='showDetail(${JSON.stringify(order).replace(/'/g, "\\'")})' class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">查看详情</button>
            </td>
          </tr>
        `).join('');
    }

    // 更新统计
    function updateStats(orders) {
      const pending = orders.filter(o => o.status === 'pending').length;
      const paid = orders.filter(o => o.status === 'paid').length;
      const totalAmount = orders.reduce((sum, o) => sum + o.amount, 0);
      
      document.getElementById('statTotal').textContent = orders.length;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statPaid').textContent = paid;
      document.getElementById('statAmount').textContent = '¥' + totalAmount.toFixed(2);
    }

    // 显示详情
    function showDetail(order) {
      const content = document.getElementById('detailContent');
      content.innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div><span class="text-gray-500">订单ID：</span><span class="font-medium">#${order.id}</span></div>
            <div><span class="text-gray-500">活动：</span><span class="font-medium">${campaigns[order.campaignId]?.name}</span></div>
            <div><span class="text-gray-500">手机号：</span><span class="font-medium">${order.phone}</span></div>
            <div><span class="text-gray-500">金额：</span><span class="font-medium text-indigo-600">¥${order.amount.toFixed(2)}</span></div>
            <div><span class="text-gray-500">状态：</span><span class="font-medium">${order.status}</span></div>
            <div><span class="text-gray-500">推荐人ID：</span><span class="font-medium">${order.referrerId || '无'}</span></div>
          </div>
          <div class="border-t pt-4">
            <div class="text-gray-500 mb-2">表单数据：</div>
            <div class="bg-gray-50 rounded p-4 space-y-2">
              ${Object.entries(order.formData || {}).map(([key, val]) => 
                `<div><span class="text-gray-600">${key}：</span><span class="font-medium">${val}</span></div>`
              ).join('')}
            </div>
          </div>
          <div class="text-sm text-gray-400">报名时间：${new Date(order.createdAt).toLocaleString()}</div>
        </div>
      `;
      document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeDetail() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        loadOrders();
      }
    }

    function nextPage() {
      if (currentPage * pageSize < total) {
        currentPage++;
        loadOrders();
      }
    }

    // 初始化
    async function init() {
      // 从 URL 获取 campaignId 参数
      const urlParams = new URLSearchParams(window.location.search);
      const campaignId = urlParams.get('campaignId');
      
      // 先加载活动列表
      await loadCampaigns();
      
      // 如果有 campaignId 参数，自动选中并查询
      if (campaignId) {
        document.getElementById('campaignFilter').value = campaignId;
        // 更新标题显示当前活动
        const campaignName = campaigns[campaignId]?.name;
        if (campaignName) {
          document.querySelector('h1').textContent = `订单管理 - ${campaignName}`;
        }
      }
      
      // 加载订单
      loadOrders();
    }
    
    init();
  </script>
</body>
</html>
