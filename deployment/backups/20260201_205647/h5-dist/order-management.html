<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DMH 订单管理</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-page.hidden { display: none; }
        .login-card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #667eea; font-size: 26px; font-weight: 700; margin-bottom: 5px; }
        .logo p { color: #666; font-size: 14px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px 14px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 15px; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        
        .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:disabled { opacity: 0.6; }
        
        .error-msg { background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 14px; display: none; }
        .test-info { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 12px; margin-top: 20px; }
        .test-info p { color: #856404; font-size: 13px; margin-bottom: 5px; }
        
        .main-page { display: none; min-height: 100vh; padding-bottom: 70px; }
        .main-page.active { display: block; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { font-size: 18px; margin: 0; }
        .header-actions { display: flex; gap: 10px; }
        .logout-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        
        .content { padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .search-box { display: flex; gap: 10px; flex: 1; }
        .search-box input { flex: 1; padding: 10px 14px; border: 1px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .search-box select { padding: 10px 14px; border: 1px solid #e1e5e9; border-radius: 8px; font-size: 14px; flex: 1; }
        .search-box button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        
        .filter-box { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; background: white; border: 1px solid #e1e5e9; border-radius: 6px; font-size: 13px; cursor: pointer; color: #666; }
        .filter-btn.active { background: #667eea; color: white; }
        .filter-btn:hover { background: #5a67d8; }
        
        .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f9fafb; padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #333; border-bottom: 1px solid #e5e7eb; }
        .table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .table tr:hover { background: #f0f9ff; }
        
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-right: 10px; }
        .status-pending { background: #fef3c7; color: #856404; }
        .status-paid { background: #10b981; color: white; }
        .status-verified { background: #059669; color: white; }
        .status-cancelled { background: #ef4444; color: #9ca3af; }
        .status-expired { background: #f59e0b; color: white; }
        
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin: 0 4px; }
        .btn-view { background: #667eea; color: white; }
        .btn-verify { background: #10b981; color: white; }
        .btn-export { background: #059669; color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; color: #333; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 8px; font-weight: 500; color: #4b5563; font-size: 13px; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline: none; border-color: #667eea; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        .order-detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .detail-item { padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; }
        .detail-label { font-size: 12px; font-weight: 500; color: #4b5563; margin-bottom: 8px; }
        .detail-value { font-size: 16px; font-weight: 600; color: #333; }
        
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; }
        .empty-icon { font-size: 48px; margin-bottom: 15px; }
        .empty-text { font-size: 14px; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 3000; display: none; }
        .toast.show { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .content { padding: 15px; }
            .search-box, .filter-box { width: 100%; }
            .table-container { border-radius: 8px; }
            .order-detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="logo">
                <h1>DMH 订单管理</h1>
                <p>数字营销中台 · 订单管理系统</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="password" value="123456" required>
                </div>
                <div id="errorMsg" class="error-msg"></div>
                <button type="submit" class="btn" id="loginBtn">登录</button>
            </form>
            <div class="test-info">
                <p><strong>测试账号</strong></p>
                <p>用户名: admin | 密码: 123456</p>
            </div>
        </div>
    </div>
    
    <!-- 主页面 -->
    <div class="main-page" id="mainPage">
        <div class="header">
            <h2><i class="ri-file-list-2-line"></i> 订单管理</h2>
            <div class="header-actions">
                <button class="logout-btn" onclick="logout()"><i class="ri-logout-box-r-line"></i> 退出</button>
            </div>
        </div>
        
        <div class="content">
            <!-- 搜索和筛选 -->
            <div class="page-header">
                <div class="search-box">
                    <input type="text" id="keywordInput" placeholder="搜索订单号、手机号...">
                    <select id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="pending">待支付</option>
                        <option value="paid">已支付</option>
                        <option value="verified">已核销</option>
                        <option value="cancelled">已取消</option>
                        <option value="expired">已过期</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">全部类型</option>
                        <option value="campaign">活动订单</option>
                        <option value="poster">海报订单</option>
                    </select>
                    <button onclick="searchOrders()"><i class="ri-search-line"></i> 搜索</button>
                </div>
                <div class="filter-box">
                    <button class="filter-btn active" onclick="filterByStatus('')">全部</button>
                    <button class="filter-btn" onclick="exportOrders()"><i class="ri-download-line"></i> 导出</button>
                </div>
            </div>
            
            <!-- 订单列表 -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>订单号</th>
                            <th>活动</th>
                            <th>类型</th>
                            <th>金额</th>
                            <th>支付状态</th>
                            <th>核销状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="ordersList">
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon"><i class="ri-loader-4-line"></i></div>
                                    <p class="empty-text">加载中...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="page-header" style="margin-top: 20px;">
                <div>
                    <button class="btn btn-view" onclick="prevPage()" id="prevBtn" disabled>上一页</button>
                    <button class="btn btn-view" onclick="nextPage()" id="nextBtn" disabled>下一页</button>
                </div>
                <div>
                    <span>第 <strong id="currentPage">1</strong> 页 / 共 <strong id="totalPages">1</strong> 页</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 订单详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">订单详情</h3>
                <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            </div>
            
            <div class="order-detail-grid" id="orderDetailContent">
                <!-- 订单详情将通过JS动态填充 -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-verify" onclick="verifyOrder()"><i class="ri-checkbox-circle-line"></i> 核销</button>
                <button class="btn btn-view" onclick="closeModal('detailModal')"><i class="ri-close-line"></i> 关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 核销模态框 -->
    <div class="modal" id="verifyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">核销订单</h3>
                <button class="modal-close" onclick="closeModal('verifyModal')">&times;</button>
            </div>
            
            <div class="form-row">
                <label>核销结果</label>
                <select id="verifyResult">
                    <option value="">请选择</option>
                    <option value="success">核销成功</option>
                    <option value="failed">核销失败</option>
                </select>
            </div>
            <div class="form-row">
                <label>备注</label>
                <textarea id="verifyRemark" placeholder="请输入核销备注..." rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="submitVerify()"><i class="ri-check-line"></i> 确认核销</button>
                <button class="btn btn-secondary" onclick="closeModal('verifyModal')">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <script>
        const API_BASE = '/api/v1';
        let authToken = localStorage.getItem('admin_token');
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let currentStatus = '';
        let currentType = '';
        let currentOrderId = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                showMainPage();
                loadOrders();
            }
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });
        
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('active');
        }
        
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.remove('active');
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('errorMsg');
            
            btn.disabled = true;
            btn.textContent = '登录中...';
            errorMsg.style.display = 'none';
            
            try {
                const res = await fetch(API_BASE + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });
                
                if (!res.ok) throw new Error('登录失败');
                
                const data = await res.json();
                authToken = data.token;
                localStorage.setItem('admin_token', authToken);
                
                showMainPage();
                loadOrders();
                
            } catch (err) {
                errorMsg.textContent = err.message;
                errorMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = '登录';
            }
        }
        
        async function loadOrders() {
            try {
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('pageSize', pageSize);
                if (currentStatus) params.append('status', currentStatus);
                if (currentType) params.append('type', currentType);
                
                const res = await fetch(API_BASE + '/orders/list?' + params.toString(), {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!res.ok) throw new Error('加载失败');
                
                const data = await res.json();
                totalPages = Math.ceil(data.total / pageSize);
                document.getElementById('totalPages').textContent = totalPages;
                
                renderOrdersList(data.orders || []);
                
            } catch (err) {
                showToast('加载失败: ' + err.message);
            }
        }
        
        function renderOrdersList(orders) {
            const tbody = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon"><i class="ri-inbox-line"></i></div>
                                <p class="empty-text">暂无订单数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.id || '-'}</td>
                    <td>${getCampaignName(order) || '-'}</td>
                    <td>${getTypeName(order) || '-'}</td>
                    <td>¥${(order.amount || 0).toFixed(2)}</td>
                    <td>${getPaymentStatusText(order.paymentStatus)}</td>
                    <td>${getVerificationStatusText(order.verificationStatus)}</td>
                    <td>${(order.createdAt || '').substring(0, 10)}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewOrder(${order.id})"><i class="ri-eye-line"></i> 详情</button>
                        <button class="action-btn btn-verify" onclick="openVerifyModal(${order.id})"><i class="ri-checkbox-line"></i> 核销</button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }
        
        function getCampaignName(order) {
            if (!order.campaignId) return '-';
            return '活动订单';
        }
        
        function getTypeName(order) {
            const types = {
                'campaign': '活动订单',
                'poster': '海报订单'
            };
            return types[order.type] || '-';
        }
        
        function getPaymentStatusText(status) {
            const map = {
                pending: '待支付',
                paid: '已支付',
                refunded: '已退款',
                failed: '支付失败'
            };
            return map[status] || status;
        }
        
        function getVerificationStatusText(status) {
            const map = {
                pending: '待核销',
                verified: '已核销',
                failed: '核销失败',
                cancelled: '已取消',
                expired: '已过期'
            };
            return map[status] || '-';
        }
        
        async function viewOrder(id) {
            try {
                const res = await fetch(API_BASE + '/orders/' + id, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!res.ok) throw new Error('获取订单失败');
                
                const order = await res.json();
                renderOrderDetail(order);
                openModal('detailModal');
                
            } catch (err) {
                showToast('加载失败: ' + err.message);
            }
        }
        
        function renderOrderDetail(order) {
            const content = document.getElementById('orderDetailContent');
            
            content.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">订单号</div>
                    <div class="detail-value">${order.id || '-'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">活动</div>
                    <div class="detail-value">${getCampaignName(order)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">类型</div>
                    <div class="detail-value">${getTypeName(order)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">金额</div>
                    <div class="detail-value">¥${(order.amount || 0).toFixed(2)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">支付状态</div>
                    <div class="detail-value">${getPaymentStatusText(order.paymentStatus)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">核销状态</div>
                    <div class="detail-value">${getVerificationStatusText(order.verificationStatus)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">创建时间</div>
                    <div class="detail-value">${(order.createdAt || '').substring(0, 10)}</div>
                </div>
            `;
            
            loadOrderVerificationRecords(order.id);
        }
        
        async function loadOrderVerificationRecords(orderId) {
            try {
                const res = await fetch(API_BASE + '/orders/' + orderId + '/verification-records', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!res.ok) throw new Error('加载核销记录失败');
                
                const data = await res.json();
                
                if (data.records && data.records.length > 0) {
                    content.innerHTML += `
                        <div class="detail-item" style="margin-top: 20px;">
                            <div class="detail-label">核销记录</div>
                            <div class="detail-value">${data.records.length} 条</div>
                        </div>
                    `;
                }
                
            } catch (err) {
                console.error('加载核销记录失败:', err);
            }
        }
        
        function openVerifyModal(id) {
            currentOrderId = id;
            document.getElementById('verifyResult').value = '';
            document.getElementById('verifyRemark').value = '';
            openModal('verifyModal');
        }
        
        async function submitVerify() {
            const result = document.getElementById('verifyResult').value;
            const remark = document.getElementById('verifyRemark').value;
            
            if (!currentOrderId) {
                showToast('订单ID无效');
                return;
            }
            
            try {
                const res = await fetch(API_BASE + '/orders/' + currentOrderId + '/verify', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        result: result,
                        remark: remark
                    })
                });
                
                if (!res.ok) throw new Error('核销失败');
                
                closeModal('verifyModal');
                showToast('核销成功');
                loadOrders();
                
            } catch (err) {
                showToast('核销失败: ' + err.message);
            }
        }
        
        function filterByStatus(status) {
            currentStatus = status;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });
            
            currentPage = 1;
            loadOrders();
        }
        
        function filterByType(type) {
            currentType = type;
            currentPage = 1;
            loadOrders();
        }
        
        function searchOrders() {
            const keyword = document.getElementById('keywordInput').value.trim();
            if (!keyword) {
                showToast('请输入搜索关键词');
                return;
            }
            currentPage = 1;
            loadOrders();
        }
        
        async function exportOrders() {
            showToast('导出功能开发中...');
            // TODO: 实现订单导出功能
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadOrders();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadOrders();
            }
        }
        
        function updatePagination() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function logout() {
            localStorage.removeItem('admin_token');
            authToken = null;
            showLoginPage();
        }
    </script>
</body>
</html>
