<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DMH 会员管理</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-page.hidden { display: none; }
        .login-card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #667eea; font-size: 26px; font-weight: 700; margin-bottom: 5px; }
        .logo p { color: #666; font-size: 14px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px 14px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 15px; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        
        .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:disabled { opacity: 0.6; }
        
        .error-msg { background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 14px; display: none; }
        .test-info { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 12px; margin-top: 20px; }
        .test-info p { color: #856404; font-size: 13px; margin-bottom: 5px; }
        
        .main-page { display: none; min-height: 100vh; padding-bottom: 70px; }
        .main-page.active { display: block; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { font-size: 18px; }
        .header-actions { display: flex; gap: 10px; }
        .logout-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        
        .content { padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .search-box { display: flex; gap: 10px; flex: 1; }
        .search-box input { flex: 1; padding: 10px 14px; border: 1px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .search-box select { padding: 10px 14px; border: 1px solid #e1e5e9; border-radius: 8px; font-size: 14px; flex: 1; }
        .search-box button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        
        .filter-box { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; background: white; border: 1px solid #e1e5e9; border-radius: 6px; font-size: 13px; cursor: pointer; color: #666; flex: 1; }
        .filter-btn.active { background: #667eea; color: white; }
        
        .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f9fafb; padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #333; border-bottom: 1px solid #e5e7eb; }
        .table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .table tr:hover { background: #f0f9ff; }
        
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-right: 10px; }
        .status-active { background: #d1fae5; color: #059669; }
        .status-disabled { background: #f3f4f6; color: #6b7280; }
        
        .action-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; margin: 0 4px; }
        .btn-view { background: #667eea; color: white; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-status { background: #10b981; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; color: #333; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 8px; font-weight: 500; color: #4b5563; font-size: 13px; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline: none; border-color: #667eea; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        .profile-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: #667eea; margin: 10px 0; }
        .stat-label { font-size: 13px; color: #666; margin-top: 5px; }
        
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .avatar-preview i { font-size: 40px; color: white; }
        
        .empty-state { text-align: center; padding: 60px; color: #9ca3af; }
        .empty-icon { font-size: 48px; margin-bottom: 15px; }
        .empty-text { font-size: 14px; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 3000; display: none; }
        .toast.show { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .content { padding: 15px; }
            .table-container { border-radius: 8px; }
            .profile-stats { grid-template-columns: repeat(2, 1fr); }
            .page-header { flex-direction: column; gap: 15px; }
            .search-box, .filter-box { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="logo">
                <h1>DMH 会员管理</h1>
                <p>数字营销中台 · 会员管理系统</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="password" value="123456" required>
                </div>
                <div id="errorMsg" class="error-msg"></div>
                <button type="submit" class="btn" id="loginBtn">登录</button>
            </form>
            <div class="test-info">
                <p><strong>测试账号</strong></p>
                <p>用户名: admin | 密码: 123456</p>
            </div>
        </div>
    </div>
    
    <!-- 主页面 -->
    <div class="main-page" id="mainPage">
        <div class="header">
            <h2><i class="ri-team-line"></i> 会员管理</h2>
            <div class="header-actions">
                <button class="logout-btn" onclick="logout()"><i class="ri-logout-box-r-line"></i> 退出</button>
            </div>
        </div>
        
        <div class="content">
            <!-- 搜索和筛选 -->
            <div class="page-header">
                <div class="search-box">
                    <input type="text" id="keywordInput" placeholder="搜索昵称或手机号...">
                    <button onclick="searchMembers()"><i class="ri-search-line"></i> 搜索</button>
                </div>
                <div class="filter-box">
                    <button class="filter-btn active" onclick="filterByStatus('')" data-status="">全部</button>
                    <button class="filter-btn" onclick="filterByStatus('active')" data-status="active">启用</button>
                    <button class="filter-btn" onclick="filterByStatus('disabled')" data-status="disabled">禁用</button>
                </div>
            </div>
            
            <!-- 会员列表 -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>头像</th>
                            <th>昵称</th>
                            <th>手机号</th>
                            <th>性别</th>
                            <th>来源</th>
                            <th>状态</th>
                            <th>注册时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="membersList">
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon"><i class="ri-loader-4-line"></i></div>
                                    <p class="empty-text">加载中...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="page-header">
                <div>
                    <button class="btn btn-view" onclick="prevPage()" id="prevBtn" disabled>上一页</button>
                    <button class="btn btn-view" onclick="nextPage()" id="nextBtn" disabled>下一页</button>
                </div>
                <div>
                    <span>第 <strong id="currentPage">1</strong> 页 / 共 <strong id="totalPages">1</strong> 页</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 会员详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">会员详情</h3>
                <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            </div>
            
            <div id="detailContent">
                <!-- 会员详情内容 -->
            </div>
        </div>
    </div>
    
    <!-- 编辑会员模态框 -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑会员</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            
            <div class="form-row">
                <label>昵称</label>
                <input type="text" id="editNickname" placeholder="请输入昵称">
            </div>
            <div class="form-row">
                <label>头像URL</label>
                <input type="text" id="editAvatar" placeholder="https://example.com/avatar.jpg">
            </div>
            <div class="form-row">
                <label>性别</label>
                <select id="editGender">
                    <option value="0">未知</option>
                    <option value="1">男</option>
                    <option value="2">女</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="saveMember()"><i class="ri-save-line"></i> 保存</button>
                <button class="btn btn-secondary" onclick="closeModal('editModal')">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <script>
        const API_BASE = '/api/v1';
        let authToken = localStorage.getItem('admin_token');
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let currentStatus = '';
        let currentMemberId = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                showMainPage();
                loadMembers();
            }
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });
        
        // 显示主页面
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('active');
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.remove('active');
        }
        
        // 登录处理
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('errorMsg');
            
            btn.disabled = true;
            btn.textContent = '登录中...';
            errorMsg.style.display = 'none';
            
            try {
                const res = await fetch(API_BASE + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });
                
                if (!res.ok) throw new Error('登录失败');
                
                const data = await res.json();
                authToken = data.token;
                localStorage.setItem('admin_token', authToken);
                
                showMainPage();
                loadMembers();
                
            } catch (err) {
                errorMsg.textContent = err.message;
                errorMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = '登录';
            }
        }
        
        // 加载会员列表
        async function loadMembers() {
            try {
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('pageSize', pageSize);
                if (currentStatus) params.append('status', currentStatus);
                
                const res = await fetch(API_BASE + '/members?' + params.toString(), {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!res.ok) throw new Error('加载失败');
                
                const data = await res.json();
                totalPages = Math.ceil(data.total / pageSize);
                document.getElementById('totalPages').textContent = totalPages;
                
                renderMembersList(data.members);
                
            } catch (err) {
                showToast('加载失败: ' + err.message);
            }
        }
        
        // 渲染会员列表
        function renderMembersList(members) {
            const tbody = document.getElementById('membersList');
            
            if (members.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon"><i class="ri-inbox-line"></i></div>
                                <p class="empty-text">暂无会员数据</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = members.map(member => `
                <tr>
                    <td>
                        <div class="avatar-preview">
                            <i class="ri-user-line"></i>
                        </div>
                    </td>
                    <td><strong>${member.nickname || '-'}</strong></td>
                    <td>${member.phone || '-'}</td>
                    <td>${member.gender === 1 ? '男' : member.gender === 2 ? '女' : '-'}</td>
                    <td>${member.source || '-'}</td>
                    <td>
                        <span class="status-badge status-${member.status}">${getStatusText(member.status)}</span>
                    </td>
                    <td>${(member.createdAt || '').substring(0, 10)}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewMember(${member.id})"><i class="ri-eye-line"></i> 详情</button>
                        <button class="action-btn btn-edit" onclick="editMember(${member.id})"><i class="ri-edit-line"></i> 编辑</button>
                        <button class="action-btn btn-status" onclick="toggleMemberStatus(${member.id}, '${member.status}')">
                            ${member.status === 'active' ? '<i class="ri-lock-line"></i>' : '<i class="ri-unlock-line"></i>'}
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const map = { active: '启用', disabled: '禁用' };
            return map[status] || status;
        }
        
        // 筛选会员
        function filterByStatus(status) {
            currentStatus = status;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });
            
            currentPage = 1;
            loadMembers();
        }
        
        // 搜索会员
        function searchMembers() {
            const keyword = document.getElementById('keywordInput').value.trim();
            if (!keyword) {
                showToast('请输入搜索关键词');
                return;
            }
            currentPage = 1;
            loadMembers();
        }
        
        // 分页
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadMembers();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadMembers();
            }
        }
        
        function updatePagination() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }
        
        // 查看会员详情
        async function viewMember(id) {
            try {
                const res = await fetch(API_BASE + '/members/' + id, {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!res.ok) throw new Error('获取详情失败');
                
                const member = await res.json();
                renderDetailModal(member);
                openModal('detailModal');
                
            } catch (err) {
                showToast('加载失败: ' + err.message);
            }
        }
        
        // 渲染详情模态框
        function renderDetailModal(member) {
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="avatar-preview">
                    <i class="ri-user-line"></i>
                </div>
                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="stat-label">会员ID</div>
                        <div class="stat-value">${member.id}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Union ID</div>
                        <div class="stat-value">${member.unionid || '-'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">状态</div>
                        <div class="stat-label status-badge status-${member.status}">${getStatusText(member.status)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">注册时间</div>
                        <div class="stat-value">${(member.createdAt || '').substring(0, 10)}</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-view" onclick="closeModal('detailModal')"><i class="ri-close-line"></i> 关闭</button>
                    <button class="btn btn-edit" onclick="editMember(${member.id})"><i class="ri-edit-line"></i> 编辑</button>
                </div>
            `;
            
            // 加载会员画像
            loadMemberProfile(member.id);
        }
        
        // 加载会员画像
        async function loadMemberProfile(memberId) {
            try {
                const res = await fetch(API_BASE + '/members/' + memberId + '/profile', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (!res.ok) throw new Error('加载画像失败');
                
                const profile = await res.json();
                
                if (profile.totalOrders === undefined) {
                    content.innerHTML += `
                        <div class="stat-card" style="grid-column: span 2;">
                            <div class="stat-label">暂无画像数据</div>
                        </div>
                    `;
                } else {
                    content.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">累计订单</div>
                            <div class="stat-value">${profile.totalOrders}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">累计支付</div>
                            <div class="stat-value">¥${profile.totalPayment.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">累计奖励</div>
                            <div class="stat-value">¥${profile.totalReward.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">首次下单</div>
                            <div class="stat-value">${profile.firstOrderAt || '-'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">最后下单</div>
                            <div class="stat-value">${profile.lastOrderAt || '-'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">参与活动</div>
                            <div class="stat-value">${profile.participatedCampaigns}个</div>
                        </div>
                    `;
                }
                
            } catch (err) {
                console.error('加载画像失败:', err);
            }
        }
        
        // 编辑会员
        function editMember(id) {
            currentMemberId = id;
            openModal('editModal');
            
            // 获取会员信息并填充表单
            fetch(API_BASE + '/members/' + id, {
                headers: { 'Authorization': 'Bearer ' + authToken }
            }).then(res => res.json())
              .then(member => {
                  document.getElementById('editNickname').value = member.nickname || '';
                  document.getElementById('editAvatar').value = member.avatar || '';
                  document.getElementById('editGender').value = member.gender || 0;
              })
              .catch(err => showToast('加载失败: ' + err.message));
        }
        
        // 保存会员
        async function saveMember() {
            const nickname = document.getElementById('editNickname').value.trim();
            const avatar = document.getElementById('editAvatar').value.trim();
            const gender = parseInt(document.getElementById('editGender').value);
            
            if (!nickname) {
                showToast('请输入昵称');
                return;
            }
            
            try {
                const res = await fetch(API_BASE + '/members/' + currentMemberId, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        avatar: avatar,
                        gender: gender
                    })
                });
                
                if (!res.ok) throw new Error('保存失败');
                
                closeModal('editModal');
                loadMembers();
                showToast('保存成功');
                
            } catch (err) {
                showToast('保存失败: ' + err.message);
            }
        }
        
        // 切换会员状态
        async function toggleMemberStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
            
            if (!confirm(`确定要${newStatus === 'active' ? '禁用' : '启用'}该会员吗？`)) {
                return;
            }
            
            try {
                const res = await fetch(API_BASE + '/members/' + id + '/status', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });
                
                if (!res.ok) throw new Error('操作失败');
                
                loadMembers();
                showToast('操作成功');
                
            } catch (err) {
                showToast('操作失败: ' + err.message);
            }
        }
        
        // 模态框控制
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // 显示提示
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // 退出登录
        function logout() {
            localStorage.removeItem('admin_token');
            authToken = null;
            showLoginPage();
        }
    </script>
</body>
</html>
