package integration

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"testing"
	"time"

	"github.com/stretchr/testify/suite"
)

// FormField 本地定义用于测试
type FormField struct {
	Type        string   `json:"type"`        // 字段类型: text, phone, email, select, textarea, address
	Name        string   `json:"name"`        // 字段名称（英文）
	Label       string   `json:"label"`       // 字段标签（中文）
	Required    bool     `json:"required"`    // 是否必填
	Placeholder string   `json:"placeholder"` // 占位符
	Options     []string `json:"options"`     // 选项列表（仅select类型）
}

// FormFieldValidationIntegrationTestSuite 表单字段验证集成测试套件
type FormFieldValidationIntegrationTestSuite struct {
	suite.Suite
	baseURL    string
	httpClient *http.Client
	authToken  string
	campaignId int64
}

func (suite *FormFieldValidationIntegrationTestSuite) SetupSuite() {
	suite.baseURL = "http://localhost:8889"
	suite.httpClient = &http.Client{Timeout: 10 * time.Second}

	// 登录获取 token
	suite.login()

	// 创建测试活动
	suite.createTestCampaign()
}

func (suite *FormFieldValidationIntegrationTestSuite) login() {
	loginReq := map[string]string{
		"username": "admin",
		"password": "123456",
	}
	reqBody, _ := json.Marshal(loginReq)

	req, _ := http.NewRequest("POST", suite.baseURL+"/api/v1/auth/login", bytes.NewBuffer(reqBody))
	req.Header.Set("Content-Type", "application/json")

	resp, err := suite.httpClient.Do(req)
	if err != nil {
		suite.T().Skipf("无法连接到后端服务，跳过测试: %v", err)
		return
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)

	var loginResp struct {
		Token string `json:"token"`
	}
	json.Unmarshal(body, &loginResp)

	if loginResp.Token == "" {
		suite.T().Skipf("登录失败，未获取到 token: %s", string(body))
		return
	}

	suite.authToken = loginResp.Token
	suite.T().Log("✓ 登录成功，获取到 token")
}

func (suite *FormFieldValidationIntegrationTestSuite) createTestCampaign() {
	now := time.Now()
	createCampaignReq := map[string]interface{}{
		"brandId":     1,
		"name":        "表单字段验证测试活动",
		"description": "用于测试表单字段配置和验证的活动",
		"rewardRule":  10.0,
		"startTime":   now.Add(1 * time.Hour).Format("2006-01-02T15:04:05"),
		"endTime":     now.Add(30 * 24 * time.Hour).Format("2006-01-02T15:04:05"),
		"formFields": []map[string]interface{}{
			{
				"type":     "text",
				"name":     "name",
				"label":    "姓名",
				"required": true,
			},
			{
				"type":     "phone",
				"name":     "phone",
				"label":    "手机号",
				"required": true,
			},
			{
				"type":     "email",
				"name":     "email",
				"label":    "邮箱",
				"required": false,
			},
			{
				"type":        "textarea",
				"name":        "address",
				"label":       "地址",
				"required":    false,
				"placeholder": "请输入详细地址",
			},
			{
				"type":        "select",
				"name":        "gender",
				"label":       "性别",
				"required":    true,
				"options":     []string{"男", "女", "其他"},
			},
		},
	}

	reqBody, _ := json.Marshal(createCampaignReq)
	req, _ := http.NewRequest("POST", suite.baseURL+"/api/v1/campaigns", bytes.NewBuffer(reqBody))
	req.Header.Set("Content-Type", "application/json")
	req.Header.Set("Authorization", "Bearer "+suite.authToken)

	resp, err := suite.httpClient.Do(req)
	if err != nil {
		suite.T().Skipf("创建活动失败: %v，跳过测试", err)
		return
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)

	if resp.StatusCode != http.StatusOK {
		suite.T().Skipf("创建活动失败，状态码: %d，响应: %s，跳过测试", resp.StatusCode, string(body))
		return
	}

	var createResp struct {
		Id int64 `json:"id"`
	}
	json.Unmarshal(body, &createResp)

	suite.campaignId = createResp.Id
	suite.T().Logf("✓ 测试活动创建成功，ID: %d", suite.campaignId)
}

// Test_11_3_1_AllFormFieldTypes 测试所有支持的表单字段类型
func (suite *FormFieldValidationIntegrationTestSuite) Test_11_3_1_AllFormFieldTypes() {
	suite.T().Log("测试场景 1: 验证所有字段类型正确保存")

	// 获取活动详情
	url := fmt.Sprintf("%s/api/v1/campaigns/%d", suite.baseURL, suite.campaignId)
	req, _ := http.NewRequest("GET", url, nil)
	req.Header.Set("Authorization", "Bearer "+suite.authToken)

	resp, err := suite.httpClient.Do(req)
	suite.Require().NoError(err)
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)

	var result struct {
		FormFields string `json:"formFields"`
	}
	json.Unmarshal(body, &result)

	// 反序列化 formFields JSON
	var formFields []FormField
	json.Unmarshal([]byte(result.FormFields), &formFields)

	// 验证所有字段类型存在
	fieldTypes := make(map[string]bool)
	for _, field := range formFields {
		fieldTypes[field.Type] = true
	}

	suite.True(fieldTypes["text"], "应包含 text 类型")
	suite.True(fieldTypes["phone"], "应包含 phone 类型")
	suite.True(fieldTypes["email"], "应包含 email 类型")
	suite.True(fieldTypes["textarea"], "应包含 textarea 类型")
	suite.True(fieldTypes["select"], "应包含 select 类型")

	suite.T().Log("✓ 所有字段类型验证通过")
}

// Test_11_3_2_FieldRequiredValidation 测试必填字段验证
func (suite *FormFieldValidationIntegrationTestSuite) Test_11_3_2_FieldRequiredValidation() {
	suite.T().Log("测试场景 2: 验证必填字段标识")

	// 获取活动详情
	url := fmt.Sprintf("%s/api/v1/campaigns/%d", suite.baseURL, suite.campaignId)
	req, _ := http.NewRequest("GET", url, nil)
	req.Header.Set("Authorization", "Bearer "+suite.authToken)

	resp, err := suite.httpClient.Do(req)
	suite.Require().NoError(err)
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)

	var result struct {
		FormFields string `json:"formFields"`
	}
	json.Unmarshal(body, &result)

	// 反序列化 formFields JSON
	var formFields []FormField
	json.Unmarshal([]byte(result.FormFields), &formFields)

	// 验证必填字段
	requiredFields := make(map[string]bool)
	for _, field := range formFields {
		if field.Required {
			requiredFields[field.Name] = true
		}
	}

	suite.True(requiredFields["name"], "姓名应为必填")
	suite.True(requiredFields["phone"], "手机号应为必填")
	suite.True(requiredFields["gender"], "性别应为必填")

	suite.T().Log("✓ 必填字段验证通过")
}

// Test_11_3_3_FieldOptions 测试select字段的选项
func (suite *FormFieldValidationIntegrationTestSuite) Test_11_3_3_FieldOptions() {
	suite.T().Log("测试场景 3: 验证select字段的选项")

	// 获取活动详情
	url := fmt.Sprintf("%s/api/v1/campaigns/%d", suite.baseURL, suite.campaignId)
	req, _ := http.NewRequest("GET", url, nil)
	req.Header.Set("Authorization", "Bearer "+suite.authToken)

	resp, err := suite.httpClient.Do(req)
	suite.Require().NoError(err)
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)

	var result struct {
		FormFields string `json:"formFields"`
	}
	json.Unmarshal(body, &result)

	// 反序列化 formFields JSON
	var formFields []FormField
	json.Unmarshal([]byte(result.FormFields), &formFields)

	// 查找 select 类型的字段
	var selectField *FormField
	for i, field := range formFields {
		if field.Type == "select" {
			selectField = &formFields[i]
			break
		}
	}

	suite.NotNil(selectField, "应存在 select 类型字段")
	suite.Len(selectField.Options, 3, "select 字段应有 3 个选项")
	suite.Contains(selectField.Options, "男", "应包含选项：男")
	suite.Contains(selectField.Options, "女", "应包含选项：女")
	suite.Contains(selectField.Options, "其他", "应包含选项：其他")

	suite.T().Log("✓ Select字段选项验证通过")
}

// TestFormFieldValidationIntegrationTestSuite 运行测试套件
func TestFormFieldValidationIntegrationTestSuite(t *testing.T) {
	suite.Run(t, new(FormFieldValidationIntegrationTestSuite))
}
